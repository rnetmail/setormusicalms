name: Deploy to VPS - Simple

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'Deploy to VPS')
    
    steps:
    - name: 🚀 Checkout code
      uses: actions/checkout@v4
      
    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: 📦 Install and build frontend
      run: |
        npm cache clean --force
        rm -rf node_modules package-lock.json
        npm install
        npm run build
        echo "✅ Frontend build concluído"
        
    - name: 🐍 Setup Python and validate backend
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 🔍 Validate backend
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python manage.py check
        echo "✅ Backend validado"
        
    - name: 🚀 Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ip-194-195-221-198.cloudezapp.io
        username: setormusicalms
        password: ${{ secrets.VPS_SSH_PASS }}
        port: ${{ secrets.VPS_SSH_PORT }}
        timeout: 300s
        command_timeout: 600s
        script: |
          echo "🚀 Iniciando deploy..."
          echo "📅 $(date)"
          
          # Ir para diretório do projeto
          cd /setormusical/setormusicalms
          
          # Parar containers
          echo "⏹️ Parando containers..."
          docker-compose down
          
          # Atualizar código
          echo "🔄 Atualizando código..."
          git fetch origin
          git reset --hard origin/main
          
          # Rebuild e restart
          echo "🏗️ Rebuilding containers..."
          docker-compose build --no-cache
          
          echo "🚀 Iniciando containers..."
          docker-compose up -d
          
          # Aguardar e verificar
          echo "⏳ Aguardando containers..."
          sleep 30
          
          echo "🔍 Status dos containers:"
          docker-compose ps
          
          # Teste simples
          echo "🧪 Testando aplicação..."
          if curl -f -s http://localhost:8001 > /dev/null; then
            echo "✅ Frontend OK"
          else
            echo "❌ Frontend com problemas"
          fi
          
          echo "🎉 Deploy concluído!"
          
    - name: 📊 Summary
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ Deploy realizado com sucesso!"
          echo "🌐 Site: https://setormusicalms.art.br"
        else
          echo "❌ Deploy falhou - verifique os logs"
        fi

