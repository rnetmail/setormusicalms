name: Deploy to VPS - Simple

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'Deploy to VPS')
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Install and build frontend
      run: |
        npm cache clean --force
        rm -rf node_modules package-lock.json
        npm install
        npm run build
        echo "âœ… Frontend build concluÃ­do"
        
    - name: ğŸ Setup Python and validate backend
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ” Validate backend
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python manage.py check
        echo "âœ… Backend validado"
        
    - name: ğŸš€ Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ip-194-195-221-198.cloudezapp.io
        username: setormusicalms
        password: ${{ secrets.VPS_SSH_PASS }}
        port: ${{ secrets.VPS_SSH_PORT }}
        timeout: 300s
        command_timeout: 600s
        script: |
          echo "ğŸš€ Iniciando deploy..."
          echo "ğŸ“… $(date)"
          
          # Ir para diretÃ³rio do projeto
          cd /setormusical/setormusicalms
          
          # Parar containers
          echo "â¹ï¸ Parando containers..."
          docker-compose down
          
          # Atualizar cÃ³digo
          echo "ğŸ”„ Atualizando cÃ³digo..."
          git fetch origin
          git reset --hard origin/main
          
          # Rebuild e restart
          echo "ğŸ—ï¸ Rebuilding containers..."
          docker-compose build --no-cache
          
          echo "ğŸš€ Iniciando containers..."
          docker-compose up -d
          
          # Aguardar e verificar
          echo "â³ Aguardando containers..."
          sleep 30
          
          echo "ğŸ” Status dos containers:"
          docker-compose ps
          
          # Teste simples
          echo "ğŸ§ª Testando aplicaÃ§Ã£o..."
          if curl -f -s http://localhost:8001 > /dev/null; then
            echo "âœ… Frontend OK"
          else
            echo "âŒ Frontend com problemas"
          fi
          
          echo "ğŸ‰ Deploy concluÃ­do!"
          
    - name: ğŸ“Š Summary
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deploy realizado com sucesso!"
          echo "ğŸŒ Site: https://setormusicalms.art.br"
        else
          echo "âŒ Deploy falhou - verifique os logs"
        fi

