# .github/workflows/deploy.yml
name: CI/CD - Testar, Construir, Implementar e Validar

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ghcr.io/${{ github.repository_owner }}/setormusicalms-backend
  IMAGE_NAME_FRONTEND: ghcr.io/${{ github.repository_owner }}/setormusicalms-frontend

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: 2. Iniciar servi√ßos com Docker Compose
        run: docker compose up -d --build

      - name: 3. Executar testes dentro do cont√™iner
        run: |
          echo "‚è≥ Aguardando sa√∫de da API..."
          timeout=90
          until docker compose exec -T backend curl -sSf http://localhost:8000/api/health; do
            timeout=$((timeout - 5))
            if [ $timeout -le 0 ]; then
              echo "‚ùå A API n√£o ficou pronta em 90s"
              docker compose logs backend
              exit 1
            fi
            sleep 5
          done
          echo "‚úÖ API saud√°vel!"

          echo "üöÄ Inicializando admin e testando endpoint..."
          docker compose exec -T backend python /app/init_admin.py

          if docker compose exec -T backend curl -sSf http://localhost:8000/api/health | grep -q '"status":"healthy"'; then
            echo "‚úÖ Teste b√°sico passou - API est√° respondendo corretamente!"
          else
            echo "‚ùå Teste falhou - API n√£o est√° respondendo corretamente"
            exit 1
          fi

      - name: 4. Encerrar containers ap√≥s testes
        if: always()
        run: docker compose down

  build_and_push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build e Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./fastapi_backend
          push: true
          tags: ${{ env.IMAGE_NAME_BACKEND }}:latest

      - name: Build e Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          dockerfile: ./frontend/Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME_FRONTEND }}:latest

  deploy_and_validate:
    needs: build_and_push
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Deploy, Initialize and Validate on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          password: ${{ secrets.VPS_SSH_PASS }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            PROJECT_DIR="${{ secrets.PROJECT_PATH_ON_VPS }}"
            echo ">>> [1/9] Acessando o diret√≥rio do projeto: $PROJECT_DIR"
            cd $PROJECT_DIR

            echo ">>> [2/9] Verificando e corrigindo permiss√µes..."
            OWNER=$(stat -c '%U' .)
            if [ "$OWNER" != "${{ secrets.VPS_SSH_USER }}" ]; then
              echo "Propriet√°rio incorreto ('$OWNER'), corrigindo..."
              sudo chown -R ${{ secrets.VPS_SSH_USER }}:${{ secrets.VPS_SSH_USER }} .
              echo "Permiss√µes corrigidas."
            else
              echo "Permiss√µes j√° est√£o corretas."
            fi

            echo ">>> [3/9] Atualizando o c√≥digo-fonte..."
            git fetch origin
            git reset --hard origin/main

            echo ">>> [4/9] Autenticando no GHCR..."
            mkdir -p ~/.docker
            echo '${{ secrets.DOCKER_CONFIG_JSON }}' > ~/.docker/config.json

            echo ">>> [5/9] Subindo os novos cont√™ineres..."
            docker compose down --remove-orphans
            docker compose pull
            docker compose up -d --build --force-recreate

            echo ">>> [6/9] Inicializando o banco de dados..."
            docker compose exec backend python /app/init_admin.py

            echo ">>> [7/9] Aguardando API backend ficar saud√°vel..."
            timeout=90
            until curl -sSf http://127.0.0.1:8001/api/health > /dev/null; do
              timeout=$((timeout - 5))
              if [ $timeout -le 0 ]; then
                echo "‚ùå Backend n√£o ficou pronto em 90s"
                docker compose logs backend --tail=50
                exit 1
              fi
              sleep 5
            done
            echo "‚úÖ Backend pronto!"

            echo ">>> [8/9] Realizando teste de fuma√ßa: Login na API..."
            if curl -s -X POST "http://127.0.0.1:8001/api/auth/login" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "username=admin&password=Setor@MS25" | grep -q '"access_token"'; then
              echo "‚úÖ Teste de fuma√ßa passou: Login bem-sucedido!"
              echo "Limpando imagens antigas..."
              docker image prune -af
            else
              echo "‚ùå ERRO: Teste de fuma√ßa falhou - N√£o foi poss√≠vel fazer login."
              echo "--- LOGS DO BACKEND ---"
              docker compose logs backend --tail=50
              exit 1
            fi

            echo "üöÄ Deploy conclu√≠do e validado com sucesso!"
