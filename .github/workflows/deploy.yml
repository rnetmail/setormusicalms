# Deploy para VPS otimizado para Fast API
name: Deploy para VPS

on:
  push:
    branches:
      - main
    # Executa apenas se a mensagem de commit contiver "Deploy to VPS"
    if: "contains(github.event.head_commit.message, 'Deploy to VPS')"

jobs:
  deploy:
    name: Deploy na VPS
    runs-on: ubuntu-latest

    steps:
      - name: Conectar via SSH e fazer Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ip-194-195-221-198.cloudezapp.io # ${{ secrets.VPS_HOST }}
          username: setormusicalms
          password: Setor@MS25 # ${{ secrets.VPS_SSH_PASS }}
          port: 22 # ${{ secrets.VPS_SSH_PORT }}
          script: |
            # Navega para o diretório do projeto
            cd ~/setormusical/setormusicalms

            # CORREÇÃO 1: Adiciona o repositório como seguro para o Git
            git config --global --add safe.directory /home/setormusicalms/setormusical/setormusicalms
            
            # Puxa as últimas alterações do repositório
            git pull origin main
            
            # Para, apaga os contêineres antigos e sobe os novos a partir das imagens reconstruídas
            docker-compose down
            docker-compose up -d --build --force-recreate
            
            # Aguarda um pouco para os serviços subirem
            echo "Aguardando 15 segundos para os serviços iniciarem..."
            sleep 15
            
            # Executa o script de inicialização do banco (se necessário)
            # O '|| true' garante que o workflow não falhe se o admin já existir
            docker-compose exec backend python init_admin.py || true

            # Mostra o status final dos contêineres
            echo "Deploy concluído! Status dos contêineres:"
            docker-compose ps
