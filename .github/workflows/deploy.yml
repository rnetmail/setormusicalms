# /.github/workflows/deploy.yml
# v2.0 - 2025-08-07 12:10:00 - Corrige execuÃ§Ã£o do init_admin.py

name: Deploy to VPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do cÃ³digo
      uses: actions/checkout@v3

    - name: Iniciar serviÃ§os com Docker Compose
      run: |
        docker-compose up -d --build
        
    - name: Executar testes dentro do contÃªiner
      run: |
        # Espera a API ficar saudÃ¡vel antes de rodar os testes
        echo "â³ Aguardando saÃºde da API..."
        for i in {1..30}; do
          if curl -f http://localhost:8000/api/health 2>/dev/null; then
            echo "âœ… API saudÃ¡vel!"
            break
          fi
          echo "curl: (7) Failed to connect to localhost port 8000 after 0 ms: Couldn't connect to server"
          sleep 2
        done
        
        curl -f http://localhost:8000/api/health
        
        echo "ğŸš€ Inicializando admin e testando endpoint..."
        # Executa o script de inicializaÃ§Ã£o do admin com Python diretamente
        docker-compose exec -T backend python /app/init_admin.py || echo "âš ï¸ Falha na inicializaÃ§Ã£o do admin, continuando..."
        
        echo "ğŸ§ª Testando endpoints da API..."
        # Testa endpoint bÃ¡sico
        curl -f http://localhost:8000/ || echo "âŒ Falha no endpoint raiz"
        
        # Testa endpoint de saÃºde
        curl -f http://localhost:8000/api/health || echo "âŒ Falha no health check"
        
        echo "âœ… Testes concluÃ­dos!"

    - name: Encerrar containers apÃ³s testes
      run: docker-compose down

  build_and_push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout do cÃ³digo
      uses: actions/checkout@v3
      
    - name: Login no Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build e push da imagem do backend
      uses: docker/build-push-action@v4
      with:
        context: ./fastapi_backend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/setormusicalms-backend:latest
        
    - name: Build e push da imagem do frontend
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/setormusicalms-frontend:latest

  deploy_and_validate:
    needs: build_and_push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy na VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "ğŸš€ Iniciando deploy na VPS..."
          
          # Navega para o diretÃ³rio do projeto
          cd /root/setormusicalms || { echo "âŒ DiretÃ³rio nÃ£o encontrado"; exit 1; }
          
          # Atualiza o cÃ³digo do repositÃ³rio
          echo "ğŸ“¥ Atualizando cÃ³digo..."
          git pull origin main
          
          # Para os containers existentes
          echo "ğŸ›‘ Parando containers..."
          docker-compose down || echo "âš ï¸ Nenhum container rodando"
          
          # Remove imagens antigas para forÃ§ar download das novas
          echo "ğŸ—‘ï¸ Removendo imagens antigas..."
          docker rmi ${{ secrets.DOCKER_USERNAME }}/setormusicalms-backend:latest || echo "âš ï¸ Imagem backend nÃ£o encontrada"
          docker rmi ${{ secrets.DOCKER_USERNAME }}/setormusicalms-frontend:latest || echo "âš ï¸ Imagem frontend nÃ£o encontrada"
          
          # Faz pull das novas imagens
          echo "ğŸ“¦ Baixando novas imagens..."
          docker pull ${{ secrets.DOCKER_USERNAME }}/setormusicalms-backend:latest
          docker pull ${{ secrets.DOCKER_USERNAME }}/setormusicalms-frontend:latest
          
          # Inicia os novos containers
          echo "ğŸš€ Iniciando novos containers..."
          docker-compose up -d
          
          # Aguarda os serviÃ§os ficarem prontos
          echo "â³ Aguardando serviÃ§os..."
          sleep 30
          
          # Executa inicializaÃ§Ã£o do admin
          echo "ğŸ‘¤ Inicializando usuÃ¡rio admin..."
          docker-compose exec -T backend python /app/init_admin.py || echo "âš ï¸ Falha na inicializaÃ§Ã£o do admin"
          
          # Verifica se os serviÃ§os estÃ£o rodando
          echo "ğŸ” Verificando status dos serviÃ§os..."
          docker-compose ps
          
          echo "âœ… Deploy concluÃ­do!"
          
    - name: Validar deploy
      run: |
        echo "ğŸ§ª Validando deploy em setormusicalms.art.br..."
        
        # Aguarda um pouco para os serviÃ§os estabilizarem
        sleep 10
        
        # Testa se o site estÃ¡ acessÃ­vel
        for i in {1..5}; do
          if curl -f -s http://setormusicalms.art.br/ >/dev/null 2>&1; then
            echo "âœ… Site acessÃ­vel!"
            break
          fi
          echo "â³ Tentativa $i/5 - aguardando site ficar disponÃ­vel..."
          sleep 10
        done
        
        # Testa endpoint da API
        if curl -f -s http://setormusicalms.art.br/api/health >/dev/null 2>&1; then
          echo "âœ… API funcionando!"
        else
          echo "âš ï¸ API pode nÃ£o estar respondendo ainda"
        fi
        
        echo "ğŸ‰ ValidaÃ§Ã£o concluÃ­da! Acesse: http://setormusicalms.art.br"
