name: Deploy to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'Deploy to VPS')
    
    steps:
    - name: ðŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Install frontend dependencies
      run: |
        npm cache clean --force
        rm -rf node_modules package-lock.json
        npm install
      
    - name: ðŸ—ï¸ Build frontend
      run: npm run build
      
    - name: ðŸ§ª Run frontend tests
      run: |
        echo "âœ… Frontend build concluÃ­do com sucesso"
        
    - name: ðŸ Setup Python for backend tests
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install backend dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ§ª Run backend tests
      run: |
        cd backend
        python manage.py check --deploy
        echo "âœ… Backend validado com sucesso"
        
    - name: ðŸš€ Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.USER_ADMIN }}
        password: ${{ secrets.VPS_SSH_PASS }}
        port: ${{ secrets.VPS_SSH_PORT }}
        script: |
          echo "ðŸš€ === Iniciando Deploy do Setor Musical MS ==="
          echo "ðŸ“… Data: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ðŸ”„ Commit: ${{ github.sha }}"
          
          # Navegar para o diretÃ³rio do projeto
          cd /setormusical/setormusicalms || { echo "âŒ DiretÃ³rio nÃ£o encontrado"; exit 1; }
          
          echo "ðŸ“¦ === Fazendo backup dos containers atuais ==="
          docker-compose down --remove-orphans || echo "âš ï¸ Containers jÃ¡ estavam parados"
          
          echo "ðŸ”„ === Sincronizando com repositÃ³rio ==="
          git fetch origin || { echo "âŒ Erro ao fazer fetch"; exit 1; }
          git reset --hard origin/main || { echo "âŒ Erro ao fazer reset"; exit 1; }
          
          echo "ðŸ“‹ === Verificando mudanÃ§as recentes ==="
          echo "Ãšltimos 5 commits:"
          git log --oneline -5
          
          echo "ðŸ—ï¸ === Construindo imagens Docker ==="
          docker-compose build --no-cache || { echo "âŒ Erro no build"; exit 1; }
          
          echo "ðŸš€ === Iniciando containers ==="
          docker-compose up -d || { echo "âŒ Erro ao iniciar containers"; exit 1; }
          
          echo "â³ === Aguardando containers iniciarem ==="
          sleep 30
          
          echo "ðŸ” === Verificando status dos containers ==="
          docker-compose ps
          
          echo "ðŸ¥ === Testando saÃºde da aplicaÃ§Ã£o ==="
          
          # Testar frontend
          echo "ðŸŒ Testando frontend..."
          if curl -f -s http://localhost:8001 > /dev/null; then
            echo "âœ… Frontend respondendo na porta 8001"
          else
            echo "âŒ Frontend nÃ£o estÃ¡ respondendo"
            docker-compose logs frontend --tail=20
          fi
          
          # Testar backend
          echo "ðŸ”§ Testando backend..."
          if docker-compose exec -T backend python manage.py check > /dev/null 2>&1; then
            echo "âœ… Backend Django estÃ¡ saudÃ¡vel"
          else
            echo "âŒ Backend Django com problemas"
            docker-compose logs backend --tail=20
          fi
          
          # Testar banco de dados
          echo "ðŸ—„ï¸ Testando banco de dados..."
          if docker-compose exec -T db pg_isready -U mestre > /dev/null 2>&1; then
            echo "âœ… Banco de dados PostgreSQL estÃ¡ saudÃ¡vel"
          else
            echo "âŒ Banco de dados com problemas"
            docker-compose logs db --tail=20
          fi
          
          echo "ðŸ“Š === Verificando logs recentes ==="
          echo "--- Logs do Frontend ---"
          docker-compose logs frontend --tail=10
          echo "--- Logs do Backend ---"
          docker-compose logs backend --tail=10
          echo "--- Logs do Banco ---"
          docker-compose logs db --tail=5
          
          echo "ðŸŽ‰ === Deploy finalizado com sucesso ==="
          echo "ðŸŒ Site disponÃ­vel em: https://setormusicalms.art.br"
          echo "âš™ï¸ Painel admin: https://setormusicalms.art.br/#/gestao/login"
          
    - name: ðŸ“Š Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ðŸŽ‰ ===== DEPLOY CONCLUÃDO COM SUCESSO ====="
          echo "âœ… AplicaÃ§Ã£o rodando corretamente!"
          echo "ðŸŒ Site: https://setormusicalms.art.br"
          echo "âš™ï¸ Painel de GestÃ£o: https://setormusicalms.art.br/#/gestao/login"
          echo "ðŸ“± Status dos containers verificado"
          echo "ðŸ” Testes de saÃºde executados"
          echo "ðŸ“… Deploy realizado em: $(date '+%Y-%m-%d %H:%M:%S')"
        else
          echo "âŒ ===== DEPLOY FALHOU ====="
          echo "ðŸ” Verifique os logs acima para identificar o problema"
          echo "ðŸ“‹ PossÃ­veis causas:"
          echo "   - Erro de build do Docker"
          echo "   - Problemas de conectividade SSH"
          echo "   - Falha nos testes de saÃºde"
          echo "   - ConfiguraÃ§Ã£o incorreta do ambiente"
          exit 1
        fi
        
    - name: ðŸ“ Create deployment summary
      if: success()
      run: |
        echo "## ðŸš€ Deploy Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Build | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Validation | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Build | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        echo "| Container Health | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        echo "| Site URL | [setormusicalms.art.br](https://setormusicalms.art.br) |" >> $GITHUB_STEP_SUMMARY
        echo "| Admin Panel | [Painel de GestÃ£o](https://setormusicalms.art.br/#/gestao/login) |" >> $GITHUB_STEP_SUMMARY
        echo "| Deploy Time | $(date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY

